<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Upgrade | Learn Elixir Language]]></title>
  <link href="http://learnelixir.com/blog/categories/upgrade/atom.xml" rel="self"/>
  <link href="http://learnelixir.com/"/>
  <updated>2014-10-29T08:09:23+08:00</updated>
  <id>http://learnelixir.com/</id>
  <author>
    <name><![CDATA[Learn Elixir]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Migrating Applications From Phoenix 0.4.1 to Phoenix 0.5.0]]></title>
    <link href="http://learnelixir.com/blog/2014/10/29/migrating-applications-from-phoenix-0-dot-4-1-to-phoenix-0-dot-5-0/"/>
    <updated>2014-10-29T06:16:12+08:00</updated>
    <id>http://learnelixir.com/blog/2014/10/29/migrating-applications-from-phoenix-0-dot-4-1-to-phoenix-0-dot-5-0</id>
    <content type="html"><![CDATA[<p>Phoenix 0.5.0 was released 2 weeks ago and it was a great release with bug fixes and a lot enhancements, performance tweaks. If you are running your application on Phoenix 0.4.1, it&rsquo;s now a good time to upgrade your app to utilise the speed of Phoenix 0.5.0. Besides those, there are some backward incompatible changes which may break your app that you should watch out when you upgrade to Phoenix 0.5.0. In this article, we are going to go through in details how to upgrade a Phoenix 0.4.0 application to a Phoenix 0.5.0.</p>

<p>The source code for the Phoenix application after upgrade to 0.5.0, which I applied inside this article is available at:</p>

<p><a href="https://github.com/learnelixir/hardware-zone/tree/phoenix-0.5.0">https://github.com/learnelixir/hardware-zone/tree/phoenix-0.5.0</a></p>

<!-- more -->


<p>To start, you will need to branch your application to another branch called phoenix-0.5.0:</p>

<pre><code class="bash">$ git checkout -b phoenix-0.5.0
</code></pre>

<h3>Before upgrading</h3>

<p>Before we start any upgrading, it&rsquo;s important to note that Phoenix 0.5.0 will only run on Elixir 1.0.1 and it&rsquo;s not compatible with Elixir 1.0.0. Hence you will need to upgrade your Elixir to 1.0.1 first if you have not done so. On your Mac, you can simply run the <code>brew install</code> command:</p>

<pre><code class="bash">$ brew install elixir
</code></pre>

<p>On Ubuntu server, you can refer to this updated article - <a href="http://learnelixir.com/blog/2014/10/16/deploy-phoenix-application-to-a-ubuntu-server/">http://learnelixir.com/blog/2014/10/16/deploy-phoenix-application-to-a-ubuntu-server/</a> - <strong>Step Number 4</strong> on how to bring up your Elixir to version 1.0.1</p>

<h3>Upgrading to Phoenix 0.5.0</h3>

<p>You will need to delete your Phoenix source folder and install the latest one by typing the following command on your terminal. This way, next time, when you generate a new Phoenix application, it will Phoenix 0.5.0:</p>

<pre><code class="bash">$ git clone https://github.com/phoenixframework/phoenix.git &amp;&amp; \
  cd phoenix &amp;&amp; \
  git checkout v0.5.0 &amp;&amp; \
  mix do deps.get, compile
</code></pre>

<h3>Upgrading application running Phoenix 0.4.1 to Phoenix 0.5.0</h3>

<p>Now enter the application folder that are still running Phoenix 0.4.1. For my case, I will upgrade the hardware zone app described in the <a href="http://learnelixir.com/blog/2014/10/18/seven-restful-actions-in-phoenix-web-app/">Seven RESTful Actions in Phoenix Web App</a>.</p>

<pre><code class="bash">$ cd ~/learn/elixir/hardware_zone
</code></pre>

<p>And then follow the following steps:</p>

<h4>Step 1 - Change Phoenix version to 0.5.0 in <code>mix.exs</code></h4>

<p>Open <code>mix.exs</code> file:</p>

<pre><code class="bash">$ vim mix.exs
</code></pre>

<p>On <code>def project</code> function, make sure your <code>elixir</code> is using <code>~&gt; 1.0.0</code>. You will also need to add in the <code>compilers</code> line below <code>elixrc_paths</code> line as following:</p>

<pre><code class="elixir">def project do
  [ app: :hardware_zone,
    version: "0.0.1",
    elixir: "~&gt; 1.0.0",
    elixirc_paths: ["lib", "web"],
    compilers: [:phoenix] ++ Mix.compilers,
    deps: deps ]
end
</code></pre>

<p>On <code>defp deps</code> function, make sure <code>phoenix</code> version is now <code>0.5.0</code>.</p>

<pre><code class="elixir">defp deps do
  [
    {:phoenix, "0.5.0"},
    {:cowboy, "~&gt; 1.0.0"},
    {:postgrex, "~&gt; 0.5"},
    {:ecto, "~&gt; 0.2.0"},
    {:plug, "~&gt; 0.8.1"},
    {:mogrify, "~&gt; 0.1"}
  ]
end
</code></pre>

<p>After that, run <code>deps.get, compile</code>:</p>

<pre><code class="bash">$ mix do deps.get, compile
</code></pre>

<h4>Step 2 - Upgrade config files</h4>

<p>There have a been a huge change in config files in config folder. Those files are <code>config.exs</code>, <code>def.exs</code>, <code>prod.exs</code> and <code>test.exs</code>. Let&rsquo;s look at them one by one</p>

<h5>config.exs</h5>

<p>Open <code>config.exs</code> file</p>

<pre><code class="bash">$ vim config/config.exs
</code></pre>

<p>Inside the function call <code>config :phoenix, HardwareZone.Router, ...</code>, you will need to change the lines for <code>port</code>, <code>ssl</code>, <code>static_assets</code>, <code>cookies</code>, <code>session_key</code> and <code>session_secret</code>:</p>

<ul>
<li>Line <code>port: System.get_env("PORT"),</code> will need to change to <code>http: [port: System.get_env("PORT")],</code>.</li>
<li>Line <code>ssl: false,</code> will need to change to <code>https: false,</code>.</li>
<li>Line <code>cookies: true,</code> will need to be removed.</li>
<li>Line <code>session_key: "_hardware_zone_key",</code> will need to be removed.</li>
<li>Line <code>session_secret: ...</code>, will need to change to <code>secret_key_base: ...</code></li>
</ul>


<p>Add line <code>url: [host: "localhost"],</code> to be right under <code>config :phoenix, HardwareZone.Router,</code> function call.</p>

<p>Effectively, the function call: <code>config :phoenix, HardwareZone.Router</code> will be like following after change:</p>

<pre><code class="elixir">config :phoenix, HardwareZone.Router,
  url: [host: "localhost"],
  http: [port: System.get_env("PORT")],
  https: false,
  secret_key_base: "oXLywfYvLeqUBlTmg2ly4HL64UpJycMiwqG2OlN95TM30AwXqXEFb...",
  catch_errors: true,
  debug_errors: false,
  error_controller: HardwareZone.PageController
</code></pre>

<p>You will also need to remove the entire function call:</p>

<pre><code class="elixir">config :phoenix, :code_reloader,
  enabled: false
</code></pre>

<p>And add in the following. Note that you will need to change the key name according to the project&rsquo;s name:</p>

<pre><code class="elixir">config :phoenix, HardwareZone.Router,
  session: [store: :cookie,
            key: "_hardware_zone_key"]
</code></pre>

<p>That&rsquo;s all for <code>config.exs</code>. Let&rsquo;s move on to <code>dev.exs</code></p>

<h5>dev.exs</h5>

<p>Open <code>dev.exs</code> file:</p>

<pre><code class="bash">$ vim config/dev.exs
</code></pre>

<p>Under <code>config :phoenix, HardwareZone.Router,</code> call you will need to remove the following lines:</p>

<pre><code class="elixir">port: System.get_env("PORT") || 4000,
ssl: false,
host: "localhost",
cookies: true,
session_key: "_hardware_zone_key",
session_secret: "VQP)JU1Z7*5L+^09X*L=6RKN9R1HL0O2E7^(1B%V3W64Z7@J9^7(M&amp;TXW8*C)...",
</code></pre>

<p>and add in this line:</p>

<pre><code class="elixir">http: [port: System.get_env("PORT") || 4000],
</code></pre>

<p>Also, remove the following block of code:</p>

<pre><code class="elixir">config :phoenix, :code_reloader,
  enabled: true

config :logger, :console,
  level: :debug
</code></pre>

<p>And add in the following line:</p>

<pre><code class="elixir">config :phoenix, :code_reloader, true
</code></pre>

<p>Effectively, for my case, it will look like following after these changes have been  made:</p>

<pre><code class="elixir">use Mix.Config

config :phoenix, HardwareZone.Router,
  http: [port: System.get_env("PORT") || 4000],
  debug_errors: true

# Enables code reloading for development
config :phoenix, :code_reloader, true
</code></pre>

<p>Let&rsquo;s move on to <code>prod.exs</code></p>

<h5>prod.exs</h5>

<p>Open <code>prod.exs</code> file:</p>

<pre><code class="bash">$ vim config/prod.exs
</code></pre>

<p>under the function call <code>config :phoenix, HardwareZone.Router,</code>, you will also need to remove the block of code:</p>

<pre><code class="elixir">port: System.get_env("PORT") || 4000,
ssl: false,
host: "localhost",
cookies: true,
session_key: "_hardware_zone_key",
session_secret: "VQP)JU1Z7*5L+^09X*L=6RKN9R1HL0O2E7^(1B%V3W64Z7@J9^7(M&amp;TXW8*C)I....",
</code></pre>

<p>and replace by the following code. Note that the secret key is different per application, hence make sure you change it:</p>

<pre><code>url: [host: "estark-sands-7697.herokuapp.com"],
http: [port: System.get_env("PORT")],
secret_key_base: "oXLywfYvLeqUBlTmg2ly4HL64UpJycMiwqG2OlN95TM30AwXqXEFbwjAbD/tgnfDDNpqFeEc..."
</code></pre>

<p>Under <code>config :logger, :console,</code> call, remove the line <code>metadata: [:request_id]</code>.</p>

<p>After all the <code>prod.exs</code> should look like below:</p>

<pre><code class="elixir">use Mix.Config

config :phoenix, HardwareZone.Router,
  url: [host: "estark-sands-7697.herokuapp.com"],
  http: [port: System.get_env("PORT")],
  secret_key_base: "oXLywfYvLeqUBlTmg2ly4HL64UpJycMiwqG2OlN95TM30AwXqXEFbwjAbD/tgnfDDNpq...."

config :logger, :console,
  level: :info
</code></pre>

<p>Now, let&rsquo;s move on to <code>prod/test.exs</code>:</p>

<h5>test.exs</h5>

<p>Open <code>test.exs</code> file:</p>

<pre><code class="bash">$ vim config/test.exs
</code></pre>

<p>under the function call <code>config :phoenix, HardwareZone.Router,</code>, you will also need to remove the block of code:</p>

<pre><code class="elixir">port: System.get_env("PORT") || 4000,
ssl: false,
host: "localhost",
cookies: true,
session_key: "_hardware_zone_key",
session_secret: "VQP)JU1Z7*5L+^09X*L=6RKN9R1HL0O2E7^(1B%V3W64Z7@J9^7(M&amp;TXW8*C)I....",
</code></pre>

<p>and replace by:</p>

<pre><code class="elixir">http: [port: System.get_env("PORT") || 4001],
catch_errors: false
</code></pre>

<p>You will also need to remove the 2 function calls:</p>

<pre><code class="elixir">config :phoenix, :code_reloader,
  enabled: true

config :logger, :console,
  level: :debug
</code></pre>

<p>Effectively, <code>test.exs</code> will look like following:</p>

<pre><code class="elixir">use Mix.Config

config :phoenix, HardwareZone.Router,
  http: [port: System.get_env("PORT") || 4001],
  catch_errors: false
</code></pre>

<p>That&rsquo;s all for config files. We can move on to the next one: <code>test/test_helper.exs</code></p>

<h4>Step 3 - <code>test/test_helper.exs</code></h4>

<p>Open <code>test/test_helper.exs</code>:</p>

<pre><code class="bash">$ vim test/test_helper.exs
</code></pre>

<p>and remove the top line:</p>

<pre><code class="elixir">Phoenix.CodeReloader.reload!
</code></pre>

<h4>Step 4 - router.ex</h4>

<p>Open <code>router.ex</code>:</p>

<pre><code class="bash">$ vim web/router.ex
</code></pre>

<p>In this file, you will need to move all the current routes to be under <code>scope "/"</code>. This change is because in Phoenix 0.5.0 introduces pipeline DSL whereby a arrival request will be eventually dispatched to a desired end-point. More information can be found <a href="https://github.com/phoenixframework/phoenix/blob/bdd9a88324d7a95fd54ba0d9904f7ff304f019d0/lib/phoenix/router.ex#L113-L220">here</a>. Let&rsquo;s start by adding on the following</p>

<pre><code class="elixir">scope "/" do
  pipe_through :browser
  ...
end
</code></pre>

<p>And then copy all your existing routes to the <code>...</code> position in the above code. For our Hardware Zone application, the end result is as following:</p>

<pre><code class="elixir">scope "/" do
    pipe_through :browser

    get "/", HardwareZone.HardwaresController, :index, as: :root
    resources "/hardwares", HardwareZone.HardwaresController
  end
</code></pre>

<p>That&rsquo;s all for <code>router.ex</code>, let&rsquo;s move on to upgrade our controllers</p>

<h4>Step 5 - Controllers</h4>

<p>Open all your controllers and put in <code>plug :action</code> under your controller name, aka.</p>

<pre><code class="elixir">defmodule HardwareZone.HardwaresController do
  use Phoenix.Controller
  ...
  plug :action

  def index(conn, _params) do
    ...
  end  
  ...
</code></pre>

<p>That&rsquo;s all for Controllers. Let&rsquo;s move on to view.</p>

<h4>Step 6 - Views</h4>

<p>You will need to open <code>web/views.ex</code> file</p>

<pre><code class="bash">$ vim web/views.ex
</code></pre>

<p>and add in the following line under the <code>import</code> <code>Router.Helpers</code> line:</p>

<pre><code class="elixir">alias Phoenix.Controller.Flash 
</code></pre>

<p>There are no step 7 :-). Happy Upgrading.</p>

<h3>Wrap Up</h3>

<p>That&rsquo;s all how we migrate from Phoenix 0.4.1 to Phoenix 0.5.0. Please leave any comments if you find anyway better way. All your comments and questions are always welcomed. :-)</p>
]]></content>
  </entry>
  
</feed>
